{"version":3,"sources":["webpack:///path---posts-translate-overreacted-how-does-setstate-know-what-to-do-733540fe78fc13d3ca1c.js","webpack:///./.cache/json/posts-translate-overreacted-how-does-setstate-know-what-to-do.json"],"names":["webpackJsonp","386","module","exports","data","markdownRemark","html","frontmatter","title","date","tag","pathContext","slug"],"mappings":"AAAAA,cAAc,iBAERC,IACA,SAAUC,EAAQC,GCHxBD,EAAAC,SAAkBC,MAAQC,gBAAkBC,KAAA,q90BAAwmxBC,aAA2qFC,MAAA,6BAAAC,KAAA,oBAAAC,IAAA,2BAAgGC,aAAgBC,KAAA","file":"path---posts-translate-overreacted-how-does-setstate-know-what-to-do-733540fe78fc13d3ca1c.js","sourcesContent":["webpackJsonp([226573307014922],{\n\n/***/ 386:\n/***/ (function(module, exports) {\n\n\tmodule.exports = {\"data\":{\"markdownRemark\":{\"html\":\"<blockquote>\\n<p>本文出自<a href=\\\"https://overreacted.io/\\\">overreacted</a>，这是<a href=\\\"https://mobile.twitter.com/dan_abramov\\\">Dan Abramov</a>写的博客，我觉得对很有用所以特意做了这个翻译<a href=\\\"/posts/overreacted\\\">系列</a>，原文链接请查看<a href=\\\"https://overreacted.io/how-does-setstate-know-what-to-do/\\\">这里</a></p>\\n</blockquote>\\n<p>当你在组件里调用<code class=\\\"language-text\\\">setState</code>的时候，你觉得发生了设么？</p>\\n<div class=\\\"gatsby-highlight\\\" data-language=\\\"jsx\\\">\\n      <pre class=\\\"language-jsx\\\"><code class=\\\"language-jsx\\\"><span class=\\\"token keyword\\\">import</span> React <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'react'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> ReactDOM <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'react-dom'</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">class</span> <span class=\\\"token class-name\\\">Button</span> <span class=\\\"token keyword\\\">extends</span> <span class=\\\"token class-name\\\">React<span class=\\\"token punctuation\\\">.</span>Component</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token function\\\">constructor</span><span class=\\\"token punctuation\\\">(</span>props<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">super</span><span class=\\\"token punctuation\\\">(</span>props<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>state <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span> clicked<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean\\\">false</span> <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>handleClick <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>handleClick<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">bind</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token function\\\">handleClick</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">setState</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span> clicked<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean\\\">true</span> <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token function\\\">render</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>state<span class=\\\"token punctuation\\\">.</span>clicked<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">return</span> <span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span>h1</span><span class=\\\"token punctuation\\\">></span></span>Thanks<span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;/</span>h1</span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">(</span>\\n      <span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span>button</span> <span class=\\\"token attr-name\\\">onClick</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span><span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>handleClick<span class=\\\"token punctuation\\\">}</span></span><span class=\\\"token punctuation\\\">></span></span>\\n        Click me<span class=\\\"token operator\\\">!</span>\\n      <span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;/</span>button</span><span class=\\\"token punctuation\\\">></span></span>\\n    <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n\\nReactDOM<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">render</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span>Button</span> <span class=\\\"token punctuation\\\">/></span></span><span class=\\\"token punctuation\\\">,</span> document<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">getElementById</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'container'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span></code></pre>\\n      </div>\\n<p>或许和你想的一样，React 通过接下来的<code class=\\\"language-text\\\">{ clicked: true }</code>状态，重新执行了渲染的函数并且将让DOM更新成了<code class=\\\"language-text\\\">&lt;h1&gt;Thanks&lt;/h1&gt;</code>元素。</p>\\n<p>看起来非常简单。那么现在的问题是，究竟是<em>React</em>做了这些？还是<em>React DOM</em>?</p>\\n<p>更新DOM看起来应该是ReactDOM的职责。但当我们调用<code class=\\\"language-text\\\">this.setState()</code>，这却不应该是React DOM的任务。而<code class=\\\"language-text\\\">React.Component</code>这个基类的任务则是定义React元素内部的结构。</p>\\n<p>那么，我们是怎么能够在<code class=\\\"language-text\\\">React.Component</code>中调用<code class=\\\"language-text\\\">setState()</code>来更新DOM的呢？</p>\\n<p><strong>放弃的分割线：就想<a href=\\\"/trasnlate-overreacted-how-does-react-tell-a-class-from-a-function/\\\">大部分</a><a href=\\\"/trasnlate-overreacted-why-do-we-write-super-props/\\\">其他的在这个blog中的</a><a href=\\\"/trasnlate-overreacted-why-do-react-elements-have-typeof-property\\\">文章一样</a>。你在生产环境中使用React，你并不需要了解这么多。这篇文章是针对那些想要解开React工作内幕的。是否看下去，完全取决于读者的选择</strong></p>\\n<hr>\\n<p>你可能会猜测，是不是<code class=\\\"language-text\\\">React.Component</code>这个类包含了更新DOM的逻辑</p>\\n<p>但是如果是这么做的话，那为什么<code class=\\\"language-text\\\">this.setState()</code>能够在这么多的生态中都能使用？比如，React Native应用中的组件也是继承于<code class=\\\"language-text\\\">React.Component</code>。在React Native中像上面那样调用<code class=\\\"language-text\\\">this.setState()</code>，在Android或者iOS原生的页面上都能够非常正常的运行。</p>\\n<p>你可能对React对React Test Renderer 或者 Shallow Renderer比较熟悉。这些测试方案让你能够在运行这些测试的时候也能够渲染这些组件。而这些都没有涉及DOM。</p>\\n<p>如果你使用过其他的渲染器比如<a href=\\\"https://github.com/facebook/react/tree/master/packages/react-art\\\">React ART</a>，你就会知道，在同一个页面，我们还能同时使用很多渲染器。(比如说，在ReactDOM的DOM树中渲染ART组件)。这使得全局标志或变量无法维持。</p>\\n<p>因此 <strong><code class=\\\"language-text\\\">React.Component</code></strong>\\nSo somehow <strong><code class=\\\"language-text\\\">React.Component</code> delegates handling state updates to the platform-specific code.</strong> Before we can understand how this happens, let’s dig deeper into how packages are separated and why.</p>\\n<hr>\\n<p>There is a common misconception that the React “engine” lives inside the <code class=\\\"language-text\\\">react</code> package. This is not true.</p>\\n<p>In fact, ever since the <a href=\\\"https://reactjs.org/blog/2015/07/03/react-v0.14-beta-1.html#two-packages\\\">package split in React 0.14</a>, the <code class=\\\"language-text\\\">react</code> package intentionally only exposes APIs for <em>defining</em> components. Most of the <em>implementation</em> of React lives in the “renderers”.</p>\\n<p><code class=\\\"language-text\\\">react-dom</code>, <code class=\\\"language-text\\\">react-dom/server</code>, <code class=\\\"language-text\\\">react-native</code>, <code class=\\\"language-text\\\">react-test-renderer</code>, <code class=\\\"language-text\\\">react-art</code> are some examples of renderers (and you can <a href=\\\"https://github.com/facebook/react/blob/master/packages/react-reconciler/README.md#practical-examples\\\">build your own</a>).</p>\\n<p>This is why the <code class=\\\"language-text\\\">react</code> package is useful regardless of which platform you target. All its exports, such as <code class=\\\"language-text\\\">React.Component</code>, <code class=\\\"language-text\\\">React.createElement</code>, <code class=\\\"language-text\\\">React.Children</code> utilities and (eventually) <a href=\\\"https://reactjs.org/docs/hooks-intro.html\\\">Hooks</a>, are independent of the target platform. Whether you run React DOM, React DOM Server, or React Native, your components would import and use them in the same way.</p>\\n<p>In contrast, the renderer packages expose platform-specific APIs like <code class=\\\"language-text\\\">ReactDOM.render()</code> that let you mount a React hierarchy into a DOM node. Each renderer provides an API like this. Ideally, most <em>components</em> shouldn’t need to import anything from a renderer. This keeps them more portable.</p>\\n<p><strong>What most people imagine as the React “engine” is inside each individual renderer.</strong> Many renderers include a copy of the same code — we call it the <a href=\\\"https://github.com/facebook/react/tree/master/packages/react-reconciler\\\">“reconciler”</a>. A <a href=\\\"https://reactjs.org/blog/2017/12/15/improving-the-repository-infrastructure.html#migrating-to-google-closure-compiler\\\">build step</a> smooshes the reconciler code together with the renderer code into a single highly optimized bundle for better performance. (Copying code is usually not great for bundle size but the vast majority of React users only needs one renderer at a time, such as <code class=\\\"language-text\\\">react-dom</code>.)</p>\\n<p>The takeaway here is that the <code class=\\\"language-text\\\">react</code> package only lets you <em>use</em> React features but doesn’t know anything about <em>how</em> they’re implemented. The renderer packages (<code class=\\\"language-text\\\">react-dom</code>, <code class=\\\"language-text\\\">react-native</code>, etc) provide the implementation of React features and platform-specific logic. Some of that code is shared (“reconciler”) but that’s an implementation detail of individual renderers.</p>\\n<hr>\\n<p>Now we know why <em>both</em> <code class=\\\"language-text\\\">react</code> and <code class=\\\"language-text\\\">react-dom</code> packages need to be updated for new features. For example, when React 16.3 added the Context API, <code class=\\\"language-text\\\">React.createContext()</code> was exposed on the React package.</p>\\n<p>But <code class=\\\"language-text\\\">React.createContext()</code> doesn’t actually <em>implement</em> the context feature. The implementation would need to be different between React DOM and React DOM Server, for example. So <code class=\\\"language-text\\\">createContext()</code> returns a few plain objects:</p>\\n<div class=\\\"gatsby-highlight\\\" data-language=\\\"js\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token comment\\\">// A bit simplified</span>\\n<span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">createContext</span><span class=\\\"token punctuation\\\">(</span>defaultValue<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">let</span> context <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n    _currentValue<span class=\\\"token punctuation\\\">:</span> defaultValue<span class=\\\"token punctuation\\\">,</span>\\n    Provider<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token keyword\\\">null</span><span class=\\\"token punctuation\\\">,</span>\\n    Consumer<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token keyword\\\">null</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n  context<span class=\\\"token punctuation\\\">.</span>Provider <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n    $$<span class=\\\"token keyword\\\">typeof</span><span class=\\\"token punctuation\\\">:</span> Symbol<span class=\\\"token punctuation\\\">.</span><span class=\\\"token keyword\\\">for</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'react.provider'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n    _context<span class=\\\"token punctuation\\\">:</span> context\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n  context<span class=\\\"token punctuation\\\">.</span>Consumer <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n    $$<span class=\\\"token keyword\\\">typeof</span><span class=\\\"token punctuation\\\">:</span> Symbol<span class=\\\"token punctuation\\\">.</span><span class=\\\"token keyword\\\">for</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'react.context'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n    _context<span class=\\\"token punctuation\\\">:</span> context<span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token keyword\\\">return</span> context<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span></code></pre>\\n      </div>\\n<p>When you use <code class=\\\"language-text\\\">&lt;MyContext.Provider&gt;</code> or <code class=\\\"language-text\\\">&lt;MyContext.Consumer&gt;</code> in the code, it’s the <em>renderer</em> that decides how to handle them. React DOM might track context values in one way, but React DOM Server might do it differently.</p>\\n<p><strong>So if you update <code class=\\\"language-text\\\">react</code> to 16.3+ but don’t update <code class=\\\"language-text\\\">react-dom</code>, you’d be using a renderer that isn’t yet aware of the special <code class=\\\"language-text\\\">Provider</code> and <code class=\\\"language-text\\\">Consumer</code> types.</strong> This is why an older <code class=\\\"language-text\\\">react-dom</code> would <a href=\\\"https://stackoverflow.com/a/49677020/458193\\\">fail saying these types are invalid</a>.</p>\\n<p>The same caveat applies to React Native. However, unlike React DOM, a React release doesn’t immediately “force” a React Native release. They have an independent release schedule. The updated renderer code is <a href=\\\"https://github.com/facebook/react-native/commits/master/Libraries/Renderer/oss\\\">separately synced</a> into the React Native repository once in a few weeks. This is why features become available in React Native on a different schedule than in React DOM.</p>\\n<hr>\\n<p>Okay, so now we know that the <code class=\\\"language-text\\\">react</code> package doesn’t contain anything interesting, and the implementation lives in renderers like <code class=\\\"language-text\\\">react-dom</code>, <code class=\\\"language-text\\\">react-native</code>, and so on. But that doesn’t answer our question. How does <code class=\\\"language-text\\\">setState()</code> inside <code class=\\\"language-text\\\">React.Component</code> “talk” to the right renderer?</p>\\n<p><strong>The answer is that every renderer sets a special field on the created class.</strong> This field is called <code class=\\\"language-text\\\">updater</code>. It’s not something <em>you</em> would set — rather, it’s something React DOM, React DOM Server or React Native set right after creating an instance of your class:</p>\\n<div class=\\\"gatsby-highlight\\\" data-language=\\\"js\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token comment\\\">// Inside React DOM</span>\\n<span class=\\\"token keyword\\\">const</span> inst <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">YourComponent</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\ninst<span class=\\\"token punctuation\\\">.</span>props <span class=\\\"token operator\\\">=</span> props<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"gatsby-highlight-code-line\\\">inst<span class=\\\"token punctuation\\\">.</span>updater <span class=\\\"token operator\\\">=</span> ReactDOMUpdater<span class=\\\"token punctuation\\\">;</span>\\n</span>\\n<span class=\\\"token comment\\\">// Inside React DOM Server</span>\\n<span class=\\\"token keyword\\\">const</span> inst <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">YourComponent</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\ninst<span class=\\\"token punctuation\\\">.</span>props <span class=\\\"token operator\\\">=</span> props<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"gatsby-highlight-code-line\\\">inst<span class=\\\"token punctuation\\\">.</span>updater <span class=\\\"token operator\\\">=</span> ReactDOMServerUpdater<span class=\\\"token punctuation\\\">;</span>\\n</span>\\n<span class=\\\"token comment\\\">// Inside React Native</span>\\n<span class=\\\"token keyword\\\">const</span> inst <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">YourComponent</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\ninst<span class=\\\"token punctuation\\\">.</span>props <span class=\\\"token operator\\\">=</span> props<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"gatsby-highlight-code-line\\\">inst<span class=\\\"token punctuation\\\">.</span>updater <span class=\\\"token operator\\\">=</span> ReactNativeUpdater<span class=\\\"token punctuation\\\">;</span>\\n</span></code></pre>\\n      </div>\\n<p>Looking at the <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react/src/ReactBaseClasses.js#L58-L67\\\"><code class=\\\"language-text\\\">setState</code> implementation in <code class=\\\"language-text\\\">React.Component</code></a>, all it does is delegate work to the renderer that created this component instance:</p>\\n<div class=\\\"gatsby-highlight\\\" data-language=\\\"js\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token comment\\\">// A bit simplified</span>\\n<span class=\\\"token function\\\">setState</span><span class=\\\"token punctuation\\\">(</span>partialState<span class=\\\"token punctuation\\\">,</span> callback<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token comment\\\">// Use the `updater` field to talk back to the renderer!</span>\\n  <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>updater<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">enqueueSetState</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">,</span> partialState<span class=\\\"token punctuation\\\">,</span> callback<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span></code></pre>\\n      </div>\\n<p>React DOM Server <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-dom/src/server/ReactPartialRenderer.js#L442-L448\\\">might want to</a> ignore a state update and warn you, whereas React DOM and React Native would let their copies of the reconciler <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-reconciler/src/ReactFiberClassComponent.js#L190-L207\\\">handle it</a>.</p>\\n<p>And this is how <code class=\\\"language-text\\\">this.setState()</code> can update the DOM even though it’s defined in the React package. It reads <code class=\\\"language-text\\\">this.updater</code> which was set by React DOM, and lets React DOM schedule and handle the update.</p>\\n<hr>\\n<p>We know about classes now, but what about Hooks?</p>\\n<p>When people first look at the <a href=\\\"https://reactjs.org/docs/hooks-intro.html\\\">Hooks proposal API</a>, they often wonder: how does <code class=\\\"language-text\\\">useState</code> “know what to do”? The assumption is that it’s more “magical” than a base <code class=\\\"language-text\\\">React.Component</code> class with <code class=\\\"language-text\\\">this.setState()</code>.</p>\\n<p>But as we have seen today, the base class <code class=\\\"language-text\\\">setState()</code> implementation has been an illusion all along. It doesn’t do anything except forwarding the call to the current renderer. And <code class=\\\"language-text\\\">useState</code> Hook <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react/src/ReactHooks.js#L55-L56\\\">does exactly the same thing</a>.</p>\\n<p><strong>Instead of an <code class=\\\"language-text\\\">updater</code> field, Hooks use a “dispatcher” object.</strong> When you call <code class=\\\"language-text\\\">React.useState()</code>, <code class=\\\"language-text\\\">React.useEffect()</code>, or another built-in Hook, these calls are forwarded to the current dispatcher.</p>\\n<div class=\\\"gatsby-highlight\\\" data-language=\\\"js\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token comment\\\">// In React (simplified a bit)</span>\\n<span class=\\\"token keyword\\\">const</span> React <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token comment\\\">// Real property is hidden a bit deeper, see if you can find it!</span>\\n  __currentDispatcher<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token keyword\\\">null</span><span class=\\\"token punctuation\\\">,</span>\\n\\n  <span class=\\\"token function\\\">useState</span><span class=\\\"token punctuation\\\">(</span>initialState<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">return</span> React<span class=\\\"token punctuation\\\">.</span>__currentDispatcher<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">useState</span><span class=\\\"token punctuation\\\">(</span>initialState<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n\\n  <span class=\\\"token function\\\">useEffect</span><span class=\\\"token punctuation\\\">(</span>initialState<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">return</span> React<span class=\\\"token punctuation\\\">.</span>__currentDispatcher<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">useEffect</span><span class=\\\"token punctuation\\\">(</span>initialState<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token comment\\\">// ...</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span></code></pre>\\n      </div>\\n<p>And individual renderers set the dispatcher before rendering your component:</p>\\n<div class=\\\"gatsby-highlight\\\" data-language=\\\"js\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token comment\\\">// In React DOM</span>\\n<span class=\\\"token keyword\\\">const</span> prevDispatcher <span class=\\\"token operator\\\">=</span> React<span class=\\\"token punctuation\\\">.</span>__currentDispatcher<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"gatsby-highlight-code-line\\\">React<span class=\\\"token punctuation\\\">.</span>__currentDispatcher <span class=\\\"token operator\\\">=</span> ReactDOMDispatcher<span class=\\\"token punctuation\\\">;</span>\\n</span><span class=\\\"token keyword\\\">let</span> result<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">try</span> <span class=\\\"token punctuation\\\">{</span>\\n  result <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">YourComponent</span><span class=\\\"token punctuation\\\">(</span>props<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">finally</span> <span class=\\\"token punctuation\\\">{</span>\\n<span class=\\\"gatsby-highlight-code-line\\\">  <span class=\\\"token comment\\\">// Restore it back</span>\\n</span><span class=\\\"gatsby-highlight-code-line\\\">  React<span class=\\\"token punctuation\\\">.</span>__currentDispatcher <span class=\\\"token operator\\\">=</span> prevDispatcher<span class=\\\"token punctuation\\\">;</span>\\n</span><span class=\\\"token punctuation\\\">}</span></code></pre>\\n      </div>\\n<p>For example, the React DOM Server implementation is <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-dom/src/server/ReactPartialRendererHooks.js#L340-L354\\\">here</a>, and the reconciler implementation shared by React DOM and React Native is <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-reconciler/src/ReactFiberHooks.js\\\">here</a>.</p>\\n<p>This is why a renderer such as <code class=\\\"language-text\\\">react-dom</code> needs to access the same <code class=\\\"language-text\\\">react</code> package that you call Hooks from. Otherwise, your component won’t “see” the dispatcher! This may not work when you have <a href=\\\"https://github.com/facebook/react/issues/13991\\\">multiple copies of React</a> in the same component tree. However, this has always led to obscure bugs so Hooks force you to solve the package duplication before it costs you.</p>\\n<p>While we don’t encourage this, you can technically override the dispatcher yourself for advanced tooling use cases. (I lied about  <code class=\\\"language-text\\\">__currentDispatcher</code> name but you can find the real one in the React repo.) For example, React DevTools will use <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-debug-tools/src/ReactDebugHooks.js#L203-L214\\\">a special purpose-built dispatcher</a> to introspect the Hooks tree by capturing JavaScript stack traces. <em>Don’t repeat this at home.</em></p>\\n<p>This also means Hooks aren’t inherently tied to React. If in the future more libraries want to reuse the same primitive Hooks, in theory the dispatcher could move to a separate package and be exposed as a first-class API with a less “scary” name. In practice, we’d prefer to avoid premature abstraction until there is a need for it.</p>\\n<p>Both the <code class=\\\"language-text\\\">updater</code> field and the <code class=\\\"language-text\\\">__currentDispatcher</code> object are forms of a generic programming principle called <em>dependency injection</em>. In both cases, the renderers “inject” implementations of features like <code class=\\\"language-text\\\">setState</code> into the generic React package to keep your components more declarative.</p>\\n<p>You don’t need to think about how this works when you use React. We’d like React users to spend more time thinking about their application code than abstract concepts like dependency injection. But if you’ve ever wondered how <code class=\\\"language-text\\\">this.setState()</code> or <code class=\\\"language-text\\\">useState()</code> know what to do, I hope this helps.</p>\\n<hr>\",\"frontmatter\":{\"title\":\"翻译：setState是如何知道接下来需要更新什么的\",\"date\":\"09 December, 2018\",\"tag\":\"translate,overreacted\"}}},\"pathContext\":{\"slug\":\"translate-overreacted-how-does-setstate-know-what-to-do\"}}\n\n/***/ })\n\n});\n\n\n// WEBPACK FOOTER //\n// path---posts-translate-overreacted-how-does-setstate-know-what-to-do-733540fe78fc13d3ca1c.js","module.exports = {\"data\":{\"markdownRemark\":{\"html\":\"<blockquote>\\n<p>本文出自<a href=\\\"https://overreacted.io/\\\">overreacted</a>，这是<a href=\\\"https://mobile.twitter.com/dan_abramov\\\">Dan Abramov</a>写的博客，我觉得对很有用所以特意做了这个翻译<a href=\\\"/posts/overreacted\\\">系列</a>，原文链接请查看<a href=\\\"https://overreacted.io/how-does-setstate-know-what-to-do/\\\">这里</a></p>\\n</blockquote>\\n<p>当你在组件里调用<code class=\\\"language-text\\\">setState</code>的时候，你觉得发生了设么？</p>\\n<div class=\\\"gatsby-highlight\\\" data-language=\\\"jsx\\\">\\n      <pre class=\\\"language-jsx\\\"><code class=\\\"language-jsx\\\"><span class=\\\"token keyword\\\">import</span> React <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'react'</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">import</span> ReactDOM <span class=\\\"token keyword\\\">from</span> <span class=\\\"token string\\\">'react-dom'</span><span class=\\\"token punctuation\\\">;</span>\\n\\n<span class=\\\"token keyword\\\">class</span> <span class=\\\"token class-name\\\">Button</span> <span class=\\\"token keyword\\\">extends</span> <span class=\\\"token class-name\\\">React<span class=\\\"token punctuation\\\">.</span>Component</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token function\\\">constructor</span><span class=\\\"token punctuation\\\">(</span>props<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">super</span><span class=\\\"token punctuation\\\">(</span>props<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>state <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span> clicked<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean\\\">false</span> <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>handleClick <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>handleClick<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">bind</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token function\\\">handleClick</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">setState</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">{</span> clicked<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token boolean\\\">true</span> <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n  <span class=\\\"token function\\\">render</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">if</span> <span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>state<span class=\\\"token punctuation\\\">.</span>clicked<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n      <span class=\\\"token keyword\\\">return</span> <span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span>h1</span><span class=\\\"token punctuation\\\">></span></span>Thanks<span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;/</span>h1</span><span class=\\\"token punctuation\\\">></span></span><span class=\\\"token punctuation\\\">;</span>\\n    <span class=\\\"token punctuation\\\">}</span>\\n    <span class=\\\"token keyword\\\">return</span> <span class=\\\"token punctuation\\\">(</span>\\n      <span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span>button</span> <span class=\\\"token attr-name\\\">onClick</span><span class=\\\"token script language-javascript\\\"><span class=\\\"token script-punctuation punctuation\\\">=</span><span class=\\\"token punctuation\\\">{</span><span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>handleClick<span class=\\\"token punctuation\\\">}</span></span><span class=\\\"token punctuation\\\">></span></span>\\n        Click me<span class=\\\"token operator\\\">!</span>\\n      <span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;/</span>button</span><span class=\\\"token punctuation\\\">></span></span>\\n    <span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span>\\n<span class=\\\"token punctuation\\\">}</span>\\n\\nReactDOM<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">render</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token tag\\\"><span class=\\\"token tag\\\"><span class=\\\"token punctuation\\\">&lt;</span>Button</span> <span class=\\\"token punctuation\\\">/></span></span><span class=\\\"token punctuation\\\">,</span> document<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">getElementById</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'container'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span></code></pre>\\n      </div>\\n<p>或许和你想的一样，React 通过接下来的<code class=\\\"language-text\\\">{ clicked: true }</code>状态，重新执行了渲染的函数并且将让DOM更新成了<code class=\\\"language-text\\\">&lt;h1&gt;Thanks&lt;/h1&gt;</code>元素。</p>\\n<p>看起来非常简单。那么现在的问题是，究竟是<em>React</em>做了这些？还是<em>React DOM</em>?</p>\\n<p>更新DOM看起来应该是ReactDOM的职责。但当我们调用<code class=\\\"language-text\\\">this.setState()</code>，这却不应该是React DOM的任务。而<code class=\\\"language-text\\\">React.Component</code>这个基类的任务则是定义React元素内部的结构。</p>\\n<p>那么，我们是怎么能够在<code class=\\\"language-text\\\">React.Component</code>中调用<code class=\\\"language-text\\\">setState()</code>来更新DOM的呢？</p>\\n<p><strong>放弃的分割线：就想<a href=\\\"/trasnlate-overreacted-how-does-react-tell-a-class-from-a-function/\\\">大部分</a><a href=\\\"/trasnlate-overreacted-why-do-we-write-super-props/\\\">其他的在这个blog中的</a><a href=\\\"/trasnlate-overreacted-why-do-react-elements-have-typeof-property\\\">文章一样</a>。你在生产环境中使用React，你并不需要了解这么多。这篇文章是针对那些想要解开React工作内幕的。是否看下去，完全取决于读者的选择</strong></p>\\n<hr>\\n<p>你可能会猜测，是不是<code class=\\\"language-text\\\">React.Component</code>这个类包含了更新DOM的逻辑</p>\\n<p>但是如果是这么做的话，那为什么<code class=\\\"language-text\\\">this.setState()</code>能够在这么多的生态中都能使用？比如，React Native应用中的组件也是继承于<code class=\\\"language-text\\\">React.Component</code>。在React Native中像上面那样调用<code class=\\\"language-text\\\">this.setState()</code>，在Android或者iOS原生的页面上都能够非常正常的运行。</p>\\n<p>你可能对React对React Test Renderer 或者 Shallow Renderer比较熟悉。这些测试方案让你能够在运行这些测试的时候也能够渲染这些组件。而这些都没有涉及DOM。</p>\\n<p>如果你使用过其他的渲染器比如<a href=\\\"https://github.com/facebook/react/tree/master/packages/react-art\\\">React ART</a>，你就会知道，在同一个页面，我们还能同时使用很多渲染器。(比如说，在ReactDOM的DOM树中渲染ART组件)。这使得全局标志或变量无法维持。</p>\\n<p>因此 <strong><code class=\\\"language-text\\\">React.Component</code></strong>\\nSo somehow <strong><code class=\\\"language-text\\\">React.Component</code> delegates handling state updates to the platform-specific code.</strong> Before we can understand how this happens, let’s dig deeper into how packages are separated and why.</p>\\n<hr>\\n<p>There is a common misconception that the React “engine” lives inside the <code class=\\\"language-text\\\">react</code> package. This is not true.</p>\\n<p>In fact, ever since the <a href=\\\"https://reactjs.org/blog/2015/07/03/react-v0.14-beta-1.html#two-packages\\\">package split in React 0.14</a>, the <code class=\\\"language-text\\\">react</code> package intentionally only exposes APIs for <em>defining</em> components. Most of the <em>implementation</em> of React lives in the “renderers”.</p>\\n<p><code class=\\\"language-text\\\">react-dom</code>, <code class=\\\"language-text\\\">react-dom/server</code>, <code class=\\\"language-text\\\">react-native</code>, <code class=\\\"language-text\\\">react-test-renderer</code>, <code class=\\\"language-text\\\">react-art</code> are some examples of renderers (and you can <a href=\\\"https://github.com/facebook/react/blob/master/packages/react-reconciler/README.md#practical-examples\\\">build your own</a>).</p>\\n<p>This is why the <code class=\\\"language-text\\\">react</code> package is useful regardless of which platform you target. All its exports, such as <code class=\\\"language-text\\\">React.Component</code>, <code class=\\\"language-text\\\">React.createElement</code>, <code class=\\\"language-text\\\">React.Children</code> utilities and (eventually) <a href=\\\"https://reactjs.org/docs/hooks-intro.html\\\">Hooks</a>, are independent of the target platform. Whether you run React DOM, React DOM Server, or React Native, your components would import and use them in the same way.</p>\\n<p>In contrast, the renderer packages expose platform-specific APIs like <code class=\\\"language-text\\\">ReactDOM.render()</code> that let you mount a React hierarchy into a DOM node. Each renderer provides an API like this. Ideally, most <em>components</em> shouldn’t need to import anything from a renderer. This keeps them more portable.</p>\\n<p><strong>What most people imagine as the React “engine” is inside each individual renderer.</strong> Many renderers include a copy of the same code — we call it the <a href=\\\"https://github.com/facebook/react/tree/master/packages/react-reconciler\\\">“reconciler”</a>. A <a href=\\\"https://reactjs.org/blog/2017/12/15/improving-the-repository-infrastructure.html#migrating-to-google-closure-compiler\\\">build step</a> smooshes the reconciler code together with the renderer code into a single highly optimized bundle for better performance. (Copying code is usually not great for bundle size but the vast majority of React users only needs one renderer at a time, such as <code class=\\\"language-text\\\">react-dom</code>.)</p>\\n<p>The takeaway here is that the <code class=\\\"language-text\\\">react</code> package only lets you <em>use</em> React features but doesn’t know anything about <em>how</em> they’re implemented. The renderer packages (<code class=\\\"language-text\\\">react-dom</code>, <code class=\\\"language-text\\\">react-native</code>, etc) provide the implementation of React features and platform-specific logic. Some of that code is shared (“reconciler”) but that’s an implementation detail of individual renderers.</p>\\n<hr>\\n<p>Now we know why <em>both</em> <code class=\\\"language-text\\\">react</code> and <code class=\\\"language-text\\\">react-dom</code> packages need to be updated for new features. For example, when React 16.3 added the Context API, <code class=\\\"language-text\\\">React.createContext()</code> was exposed on the React package.</p>\\n<p>But <code class=\\\"language-text\\\">React.createContext()</code> doesn’t actually <em>implement</em> the context feature. The implementation would need to be different between React DOM and React DOM Server, for example. So <code class=\\\"language-text\\\">createContext()</code> returns a few plain objects:</p>\\n<div class=\\\"gatsby-highlight\\\" data-language=\\\"js\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token comment\\\">// A bit simplified</span>\\n<span class=\\\"token keyword\\\">function</span> <span class=\\\"token function\\\">createContext</span><span class=\\\"token punctuation\\\">(</span>defaultValue<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token keyword\\\">let</span> context <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n    _currentValue<span class=\\\"token punctuation\\\">:</span> defaultValue<span class=\\\"token punctuation\\\">,</span>\\n    Provider<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token keyword\\\">null</span><span class=\\\"token punctuation\\\">,</span>\\n    Consumer<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token keyword\\\">null</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n  context<span class=\\\"token punctuation\\\">.</span>Provider <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n    $$<span class=\\\"token keyword\\\">typeof</span><span class=\\\"token punctuation\\\">:</span> Symbol<span class=\\\"token punctuation\\\">.</span><span class=\\\"token keyword\\\">for</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'react.provider'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n    _context<span class=\\\"token punctuation\\\">:</span> context\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n  context<span class=\\\"token punctuation\\\">.</span>Consumer <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n    $$<span class=\\\"token keyword\\\">typeof</span><span class=\\\"token punctuation\\\">:</span> Symbol<span class=\\\"token punctuation\\\">.</span><span class=\\\"token keyword\\\">for</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token string\\\">'react.context'</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">,</span>\\n    _context<span class=\\\"token punctuation\\\">:</span> context<span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token keyword\\\">return</span> context<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span></code></pre>\\n      </div>\\n<p>When you use <code class=\\\"language-text\\\">&lt;MyContext.Provider&gt;</code> or <code class=\\\"language-text\\\">&lt;MyContext.Consumer&gt;</code> in the code, it’s the <em>renderer</em> that decides how to handle them. React DOM might track context values in one way, but React DOM Server might do it differently.</p>\\n<p><strong>So if you update <code class=\\\"language-text\\\">react</code> to 16.3+ but don’t update <code class=\\\"language-text\\\">react-dom</code>, you’d be using a renderer that isn’t yet aware of the special <code class=\\\"language-text\\\">Provider</code> and <code class=\\\"language-text\\\">Consumer</code> types.</strong> This is why an older <code class=\\\"language-text\\\">react-dom</code> would <a href=\\\"https://stackoverflow.com/a/49677020/458193\\\">fail saying these types are invalid</a>.</p>\\n<p>The same caveat applies to React Native. However, unlike React DOM, a React release doesn’t immediately “force” a React Native release. They have an independent release schedule. The updated renderer code is <a href=\\\"https://github.com/facebook/react-native/commits/master/Libraries/Renderer/oss\\\">separately synced</a> into the React Native repository once in a few weeks. This is why features become available in React Native on a different schedule than in React DOM.</p>\\n<hr>\\n<p>Okay, so now we know that the <code class=\\\"language-text\\\">react</code> package doesn’t contain anything interesting, and the implementation lives in renderers like <code class=\\\"language-text\\\">react-dom</code>, <code class=\\\"language-text\\\">react-native</code>, and so on. But that doesn’t answer our question. How does <code class=\\\"language-text\\\">setState()</code> inside <code class=\\\"language-text\\\">React.Component</code> “talk” to the right renderer?</p>\\n<p><strong>The answer is that every renderer sets a special field on the created class.</strong> This field is called <code class=\\\"language-text\\\">updater</code>. It’s not something <em>you</em> would set — rather, it’s something React DOM, React DOM Server or React Native set right after creating an instance of your class:</p>\\n<div class=\\\"gatsby-highlight\\\" data-language=\\\"js\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token comment\\\">// Inside React DOM</span>\\n<span class=\\\"token keyword\\\">const</span> inst <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">YourComponent</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\ninst<span class=\\\"token punctuation\\\">.</span>props <span class=\\\"token operator\\\">=</span> props<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"gatsby-highlight-code-line\\\">inst<span class=\\\"token punctuation\\\">.</span>updater <span class=\\\"token operator\\\">=</span> ReactDOMUpdater<span class=\\\"token punctuation\\\">;</span>\\n</span>\\n<span class=\\\"token comment\\\">// Inside React DOM Server</span>\\n<span class=\\\"token keyword\\\">const</span> inst <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">YourComponent</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\ninst<span class=\\\"token punctuation\\\">.</span>props <span class=\\\"token operator\\\">=</span> props<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"gatsby-highlight-code-line\\\">inst<span class=\\\"token punctuation\\\">.</span>updater <span class=\\\"token operator\\\">=</span> ReactDOMServerUpdater<span class=\\\"token punctuation\\\">;</span>\\n</span>\\n<span class=\\\"token comment\\\">// Inside React Native</span>\\n<span class=\\\"token keyword\\\">const</span> inst <span class=\\\"token operator\\\">=</span> <span class=\\\"token keyword\\\">new</span> <span class=\\\"token class-name\\\">YourComponent</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\ninst<span class=\\\"token punctuation\\\">.</span>props <span class=\\\"token operator\\\">=</span> props<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"gatsby-highlight-code-line\\\">inst<span class=\\\"token punctuation\\\">.</span>updater <span class=\\\"token operator\\\">=</span> ReactNativeUpdater<span class=\\\"token punctuation\\\">;</span>\\n</span></code></pre>\\n      </div>\\n<p>Looking at the <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react/src/ReactBaseClasses.js#L58-L67\\\"><code class=\\\"language-text\\\">setState</code> implementation in <code class=\\\"language-text\\\">React.Component</code></a>, all it does is delegate work to the renderer that created this component instance:</p>\\n<div class=\\\"gatsby-highlight\\\" data-language=\\\"js\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token comment\\\">// A bit simplified</span>\\n<span class=\\\"token function\\\">setState</span><span class=\\\"token punctuation\\\">(</span>partialState<span class=\\\"token punctuation\\\">,</span> callback<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token comment\\\">// Use the `updater` field to talk back to the renderer!</span>\\n  <span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">.</span>updater<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">enqueueSetState</span><span class=\\\"token punctuation\\\">(</span><span class=\\\"token keyword\\\">this</span><span class=\\\"token punctuation\\\">,</span> partialState<span class=\\\"token punctuation\\\">,</span> callback<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span></code></pre>\\n      </div>\\n<p>React DOM Server <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-dom/src/server/ReactPartialRenderer.js#L442-L448\\\">might want to</a> ignore a state update and warn you, whereas React DOM and React Native would let their copies of the reconciler <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-reconciler/src/ReactFiberClassComponent.js#L190-L207\\\">handle it</a>.</p>\\n<p>And this is how <code class=\\\"language-text\\\">this.setState()</code> can update the DOM even though it’s defined in the React package. It reads <code class=\\\"language-text\\\">this.updater</code> which was set by React DOM, and lets React DOM schedule and handle the update.</p>\\n<hr>\\n<p>We know about classes now, but what about Hooks?</p>\\n<p>When people first look at the <a href=\\\"https://reactjs.org/docs/hooks-intro.html\\\">Hooks proposal API</a>, they often wonder: how does <code class=\\\"language-text\\\">useState</code> “know what to do”? The assumption is that it’s more “magical” than a base <code class=\\\"language-text\\\">React.Component</code> class with <code class=\\\"language-text\\\">this.setState()</code>.</p>\\n<p>But as we have seen today, the base class <code class=\\\"language-text\\\">setState()</code> implementation has been an illusion all along. It doesn’t do anything except forwarding the call to the current renderer. And <code class=\\\"language-text\\\">useState</code> Hook <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react/src/ReactHooks.js#L55-L56\\\">does exactly the same thing</a>.</p>\\n<p><strong>Instead of an <code class=\\\"language-text\\\">updater</code> field, Hooks use a “dispatcher” object.</strong> When you call <code class=\\\"language-text\\\">React.useState()</code>, <code class=\\\"language-text\\\">React.useEffect()</code>, or another built-in Hook, these calls are forwarded to the current dispatcher.</p>\\n<div class=\\\"gatsby-highlight\\\" data-language=\\\"js\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token comment\\\">// In React (simplified a bit)</span>\\n<span class=\\\"token keyword\\\">const</span> React <span class=\\\"token operator\\\">=</span> <span class=\\\"token punctuation\\\">{</span>\\n  <span class=\\\"token comment\\\">// Real property is hidden a bit deeper, see if you can find it!</span>\\n  __currentDispatcher<span class=\\\"token punctuation\\\">:</span> <span class=\\\"token keyword\\\">null</span><span class=\\\"token punctuation\\\">,</span>\\n\\n  <span class=\\\"token function\\\">useState</span><span class=\\\"token punctuation\\\">(</span>initialState<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">return</span> React<span class=\\\"token punctuation\\\">.</span>__currentDispatcher<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">useState</span><span class=\\\"token punctuation\\\">(</span>initialState<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n\\n  <span class=\\\"token function\\\">useEffect</span><span class=\\\"token punctuation\\\">(</span>initialState<span class=\\\"token punctuation\\\">)</span> <span class=\\\"token punctuation\\\">{</span>\\n    <span class=\\\"token keyword\\\">return</span> React<span class=\\\"token punctuation\\\">.</span>__currentDispatcher<span class=\\\"token punctuation\\\">.</span><span class=\\\"token function\\\">useEffect</span><span class=\\\"token punctuation\\\">(</span>initialState<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n  <span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">,</span>\\n  <span class=\\\"token comment\\\">// ...</span>\\n<span class=\\\"token punctuation\\\">}</span><span class=\\\"token punctuation\\\">;</span></code></pre>\\n      </div>\\n<p>And individual renderers set the dispatcher before rendering your component:</p>\\n<div class=\\\"gatsby-highlight\\\" data-language=\\\"js\\\">\\n      <pre class=\\\"language-js\\\"><code class=\\\"language-js\\\"><span class=\\\"token comment\\\">// In React DOM</span>\\n<span class=\\\"token keyword\\\">const</span> prevDispatcher <span class=\\\"token operator\\\">=</span> React<span class=\\\"token punctuation\\\">.</span>__currentDispatcher<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"gatsby-highlight-code-line\\\">React<span class=\\\"token punctuation\\\">.</span>__currentDispatcher <span class=\\\"token operator\\\">=</span> ReactDOMDispatcher<span class=\\\"token punctuation\\\">;</span>\\n</span><span class=\\\"token keyword\\\">let</span> result<span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token keyword\\\">try</span> <span class=\\\"token punctuation\\\">{</span>\\n  result <span class=\\\"token operator\\\">=</span> <span class=\\\"token function\\\">YourComponent</span><span class=\\\"token punctuation\\\">(</span>props<span class=\\\"token punctuation\\\">)</span><span class=\\\"token punctuation\\\">;</span>\\n<span class=\\\"token punctuation\\\">}</span> <span class=\\\"token keyword\\\">finally</span> <span class=\\\"token punctuation\\\">{</span>\\n<span class=\\\"gatsby-highlight-code-line\\\">  <span class=\\\"token comment\\\">// Restore it back</span>\\n</span><span class=\\\"gatsby-highlight-code-line\\\">  React<span class=\\\"token punctuation\\\">.</span>__currentDispatcher <span class=\\\"token operator\\\">=</span> prevDispatcher<span class=\\\"token punctuation\\\">;</span>\\n</span><span class=\\\"token punctuation\\\">}</span></code></pre>\\n      </div>\\n<p>For example, the React DOM Server implementation is <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-dom/src/server/ReactPartialRendererHooks.js#L340-L354\\\">here</a>, and the reconciler implementation shared by React DOM and React Native is <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-reconciler/src/ReactFiberHooks.js\\\">here</a>.</p>\\n<p>This is why a renderer such as <code class=\\\"language-text\\\">react-dom</code> needs to access the same <code class=\\\"language-text\\\">react</code> package that you call Hooks from. Otherwise, your component won’t “see” the dispatcher! This may not work when you have <a href=\\\"https://github.com/facebook/react/issues/13991\\\">multiple copies of React</a> in the same component tree. However, this has always led to obscure bugs so Hooks force you to solve the package duplication before it costs you.</p>\\n<p>While we don’t encourage this, you can technically override the dispatcher yourself for advanced tooling use cases. (I lied about  <code class=\\\"language-text\\\">__currentDispatcher</code> name but you can find the real one in the React repo.) For example, React DevTools will use <a href=\\\"https://github.com/facebook/react/blob/ce43a8cd07c355647922480977b46713bd51883e/packages/react-debug-tools/src/ReactDebugHooks.js#L203-L214\\\">a special purpose-built dispatcher</a> to introspect the Hooks tree by capturing JavaScript stack traces. <em>Don’t repeat this at home.</em></p>\\n<p>This also means Hooks aren’t inherently tied to React. If in the future more libraries want to reuse the same primitive Hooks, in theory the dispatcher could move to a separate package and be exposed as a first-class API with a less “scary” name. In practice, we’d prefer to avoid premature abstraction until there is a need for it.</p>\\n<p>Both the <code class=\\\"language-text\\\">updater</code> field and the <code class=\\\"language-text\\\">__currentDispatcher</code> object are forms of a generic programming principle called <em>dependency injection</em>. In both cases, the renderers “inject” implementations of features like <code class=\\\"language-text\\\">setState</code> into the generic React package to keep your components more declarative.</p>\\n<p>You don’t need to think about how this works when you use React. We’d like React users to spend more time thinking about their application code than abstract concepts like dependency injection. But if you’ve ever wondered how <code class=\\\"language-text\\\">this.setState()</code> or <code class=\\\"language-text\\\">useState()</code> know what to do, I hope this helps.</p>\\n<hr>\",\"frontmatter\":{\"title\":\"翻译：setState是如何知道接下来需要更新什么的\",\"date\":\"09 December, 2018\",\"tag\":\"translate,overreacted\"}}},\"pathContext\":{\"slug\":\"translate-overreacted-how-does-setstate-know-what-to-do\"}}\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./~/json-loader!./.cache/json/posts-translate-overreacted-how-does-setstate-know-what-to-do.json\n// module id = 386\n// module chunks = 226573307014922"],"sourceRoot":""}